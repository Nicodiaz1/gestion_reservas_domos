<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="admin-page">
    <header>
        <div class="container">
            <h1>‚öôÔ∏è Panel Administrativo</h1>
            <a href="/admin/logout" class="btn btn-danger">Cerrar Sesi√≥n</a>
        </div>
    </header>

    <main class="container admin-container">
        <div class="sidebar">
            <nav>
                <button class="nav-btn active" data-tab="reservas">üìã Reservas</button>
                <button class="nav-btn" data-tab="canceladas">‚ùå Canceladas</button>
                <button class="nav-btn" data-tab="finalizadas">‚úÖ Finalizadas</button>
                <button class="nav-btn" data-tab="galeria">üñºÔ∏è Galer√≠a</button>
                <button class="nav-btn" data-tab="promociones">üè∑Ô∏è Promociones</button>
            </nav>
        </div>

        <div class="content">
            <div class="filters-bar">
                <div class="filter-group">
                    <label for="filtro-fecha-inicio">Desde</label>
                    <input type="date" id="filtro-fecha-inicio">
                </div>
                <div class="filter-group">
                    <label for="filtro-fecha-fin">Hasta</label>
                    <input type="date" id="filtro-fecha-fin">
                </div>
                <div class="filter-group filter-search">
                    <label for="filtro-busqueda">Buscar cliente</label>
                    <input type="text" id="filtro-busqueda" placeholder="Nombre, email o tel√©fono">
                </div>
                <button class="btn btn-secondary" id="filtro-limpiar">Limpiar</button>
            </div>

            <!-- TAB: RESERVAS -->
            <div id="tab-reservas" class="tab-content active">
                <h2>Reservas Activas</h2>
                <div id="reservasContainer" class="reservas-list">
                    <p>Cargando...</p>
                </div>
            </div>

            <!-- TAB: CANCELADAS -->
            <div id="tab-canceladas" class="tab-content">
                <h2>Reservas Canceladas</h2>
                <div id="canceladasContainer" class="reservas-list">
                    <p>Cargando...</p>
                </div>
            </div>

            <!-- TAB: FINALIZADAS -->
            <div id="tab-finalizadas" class="tab-content">
                <h2>Reservas Finalizadas</h2>
                <div id="finalizadasContainer" class="reservas-list">
                    <p>Cargando...</p>
                </div>
            </div>

            <!-- TAB: GALERIA -->
            <div id="tab-galeria" class="tab-content">
                <h2>Galer√≠a</h2>
                <div class="card" style="margin-bottom: 16px;">
                    <h3 style="margin-bottom: 12px;">Agregar foto</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="galeria-url">URL de la imagen</label>
                            <input type="text" id="galeria-url" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="galeria-titulo">T√≠tulo (opcional)</label>
                            <input type="text" id="galeria-titulo" placeholder="Descripci√≥n corta">
                        </div>
                        <div class="form-group">
                            <label for="galeria-orden">Orden</label>
                            <input type="number" id="galeria-orden" value="0" min="0">
                        </div>
                    </div>
                    <button class="btn btn-primary" id="galeria-guardar">Guardar foto</button>
                </div>
                <div id="galeria-admin-list" class="reservas-list">
                    <p>Cargando...</p>
                </div>
            </div>

            <!-- TAB: PROMOCIONES -->
            <div id="tab-promociones" class="tab-content">
                <h2>Promociones</h2>
                <div class="card" style="margin-bottom: 16px;">
                    <h3 style="margin-bottom: 12px;">Agregar promoci√≥n</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="promo-titulo">T√≠tulo</label>
                            <input type="text" id="promo-titulo" placeholder="Ej: 2x1 en semana">
                        </div>
                        <div class="form-group">
                            <label for="promo-detalle">Detalle (opcional)</label>
                            <input type="text" id="promo-detalle" placeholder="Ej: V√°lido hasta 30/06">
                        </div>
                        <div class="form-group">
                            <label for="promo-orden">Orden</label>
                            <input type="number" id="promo-orden" value="0" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="promo-descripcion">Descripci√≥n</label>
                        <textarea id="promo-descripcion" rows="3" placeholder="Descripci√≥n de la promo"></textarea>
                    </div>
                    <button class="btn btn-primary" id="promo-guardar">Guardar promoci√≥n</button>
                </div>
                <div id="promos-admin-list" class="reservas-list">
                    <p>Cargando...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Cambiar tabs
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('tab-' + this.dataset.tab).classList.add('active');
            });
        });

        // ========== RESERVAS ==========
        let reservasCache = [];

        function normalizarTexto(valor) {
            return (valor || '').toString().toLowerCase().trim();
        }

        function filtrarReservas(lista) {
            const fechaInicioFiltro = document.getElementById('filtro-fecha-inicio').value;
            const fechaFinFiltro = document.getElementById('filtro-fecha-fin').value;
            const busqueda = normalizarTexto(document.getElementById('filtro-busqueda').value);

            const filtroInicio = fechaInicioFiltro ? new Date(fechaInicioFiltro) : null;
            const filtroFin = fechaFinFiltro ? new Date(fechaFinFiltro) : null;

            return lista.filter(r => {
                const inicio = new Date(r.fecha_inicio);
                const fin = new Date(r.fecha_fin);

                const coincideTexto = !busqueda || [
                    normalizarTexto(r.nombre_cliente),
                    normalizarTexto(r.email_cliente),
                    normalizarTexto(r.telefono_cliente),
                    normalizarTexto(r.domo_nombre)
                ].some(valor => valor.includes(busqueda));

                let coincideFecha = true;
                if (filtroInicio && filtroFin) {
                    coincideFecha = fin >= filtroInicio && inicio <= filtroFin;
                } else if (filtroInicio) {
                    coincideFecha = fin >= filtroInicio;
                } else if (filtroFin) {
                    coincideFecha = inicio <= filtroFin;
                }

                return coincideTexto && coincideFecha;
            });
        }

        function renderReservas() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            const activas = [];
            const canceladas = [];
            const finalizadas = [];

            filtrarReservas(reservasCache).forEach(r => {
                const fechaFin = new Date(r.fecha_fin);
                if (r.estado === 'cancelada') {
                    canceladas.push(r);
                } else if (fechaFin < hoy) {
                    finalizadas.push(r);
                } else {
                    activas.push(r);
                }
            });

            const activasHtml = activas.map(r => buildReservaCard(r, { canCancel: true })).join('');
            const canceladasHtml = canceladas.map(r => buildReservaCard(r, { canDelete: true })).join('');
            const finalizadasHtml = finalizadas.map(r => buildReservaCard(r, { canDelete: true })).join('');

            document.getElementById('reservasContainer').innerHTML = activasHtml || '<p>Sin reservas activas</p>';
            document.getElementById('canceladasContainer').innerHTML = canceladasHtml || '<p>Sin reservas canceladas</p>';
            document.getElementById('finalizadasContainer').innerHTML = finalizadasHtml || '<p>Sin reservas finalizadas</p>';
        }

        function buildReservaCard(r, options = {}) {
            const actions = [];
            if (options.canCancel && r.estado === 'confirmada') {
                actions.push(`<button class="btn btn-danger" onclick="cancelarReserva(${r.id})">Cancelar</button>`);
            }
            if (options.canDelete) {
                actions.push(`<button class="btn btn-secondary" onclick="eliminarReserva(${r.id})">Eliminar</button>`);
            }

            return `
                <div class="reserva-card">
                    <div class="reserva-header">
                        <h3>${r.domo_nombre}</h3>
                        <span class="status ${r.estado}">${r.estado}</span>
                    </div>
                    <div class="reserva-body">
                        <p><strong>Cliente:</strong> ${r.nombre_cliente}</p>
                        <p><strong>Email:</strong> ${r.email_cliente || 'N/A'}</p>
                        <p><strong>Tel√©fono:</strong> ${r.telefono_cliente || 'N/A'}</p>
                        <p><strong>Fechas:</strong> ${r.fecha_inicio} a ${r.fecha_fin}</p>
                    </div>
                    ${actions.length ? `<div class="reserva-actions">${actions.join('')}</div>` : ''}
                </div>
            `;
        }

        async function cargarReservas() {
            try {
                const res = await fetch('/api/admin/reservas');
                reservasCache = await res.json();
                renderReservas();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cancelarReserva(reservaId) {
            if (!confirm('¬øCancelar esta reserva?')) return;
            try {
                const res = await fetch(`/api/admin/reserva/${reservaId}`, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok) {
                    cargarReservas();
                    alert('Reserva cancelada');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function eliminarReserva(reservaId) {
            if (!confirm('¬øEliminar definitivamente esta reserva?')) return;
            try {
                const res = await fetch(`/api/admin/reserva/${reservaId}/eliminar`, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok) {
                    cargarReservas();
                    alert('Reserva eliminada');
                } else {
                    alert(data.error || 'No se pudo eliminar');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('filtro-fecha-inicio').addEventListener('change', renderReservas);
        document.getElementById('filtro-fecha-fin').addEventListener('change', renderReservas);
        document.getElementById('filtro-busqueda').addEventListener('input', renderReservas);
        document.getElementById('filtro-limpiar').addEventListener('click', () => {
            document.getElementById('filtro-fecha-inicio').value = '';
            document.getElementById('filtro-fecha-fin').value = '';
            document.getElementById('filtro-busqueda').value = '';
            renderReservas();
        });

        // ========== GALERIA ==========
        async function cargarGaleriaAdmin() {
            try {
                const res = await fetch('/api/admin/galeria');
                const data = await res.json();
                const html = data.map(f => `
                    <div class="reserva-card">
                        <div class="reserva-header">
                            <h3>${f.titulo || 'Foto sin t√≠tulo'}</h3>
                        </div>
                        <div class="reserva-body">
                            <p><strong>Orden:</strong> ${f.orden}</p>
                            <p style="word-break: break-all;"><strong>URL:</strong> ${f.url}</p>
                        </div>
                        <div class="reserva-actions">
                            <button class="btn btn-secondary" onclick="eliminarFoto(${f.id})">Eliminar</button>
                        </div>
                    </div>
                `).join('');
                document.getElementById('galeria-admin-list').innerHTML = html || '<p>Sin fotos cargadas</p>';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function eliminarFoto(fotoId) {
            if (!confirm('¬øEliminar esta foto?')) return;
            const res = await fetch(`/api/admin/galeria/${fotoId}`, { method: 'DELETE' });
            if (res.ok) cargarGaleriaAdmin();
        }

        document.getElementById('galeria-guardar').addEventListener('click', async () => {
            const url = document.getElementById('galeria-url').value.trim();
            const titulo = document.getElementById('galeria-titulo').value.trim();
            const orden = document.getElementById('galeria-orden').value || 0;
            if (!url) return alert('URL requerida');
            const res = await fetch('/api/admin/galeria', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, titulo, orden })
            });
            if (res.ok) {
                document.getElementById('galeria-url').value = '';
                document.getElementById('galeria-titulo').value = '';
                document.getElementById('galeria-orden').value = 0;
                cargarGaleriaAdmin();
            }
        });

        // ========== PROMOCIONES ==========
        async function cargarPromosAdmin() {
            try {
                const res = await fetch('/api/admin/promociones');
                const data = await res.json();
                const html = data.map(p => `
                    <div class="reserva-card">
                        <div class="reserva-header">
                            <h3>${p.titulo}</h3>
                            <span class="status ${p.activo ? 'confirmada' : 'cancelada'}">${p.activo ? 'activa' : 'inactiva'}</span>
                        </div>
                        <div class="reserva-body">
                            <p>${p.descripcion}</p>
                            ${p.detalle ? `<p><strong>Detalle:</strong> ${p.detalle}</p>` : ''}
                            <p><strong>Orden:</strong> ${p.orden}</p>
                        </div>
                        <div class="reserva-actions">
                            <button class="btn btn-secondary" onclick="eliminarPromo(${p.id})">Eliminar</button>
                        </div>
                    </div>
                `).join('');
                document.getElementById('promos-admin-list').innerHTML = html || '<p>Sin promociones</p>';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function eliminarPromo(promoId) {
            if (!confirm('¬øEliminar esta promoci√≥n?')) return;
            const res = await fetch(`/api/admin/promociones/${promoId}`, { method: 'DELETE' });
            if (res.ok) cargarPromosAdmin();
        }

        document.getElementById('promo-guardar').addEventListener('click', async () => {
            const titulo = document.getElementById('promo-titulo').value.trim();
            const descripcion = document.getElementById('promo-descripcion').value.trim();
            const detalle = document.getElementById('promo-detalle').value.trim();
            const orden = document.getElementById('promo-orden').value || 0;
            if (!titulo || !descripcion) return alert('T√≠tulo y descripci√≥n requeridos');
            const res = await fetch('/api/admin/promociones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ titulo, descripcion, detalle, orden })
            });
            if (res.ok) {
                document.getElementById('promo-titulo').value = '';
                document.getElementById('promo-descripcion').value = '';
                document.getElementById('promo-detalle').value = '';
                document.getElementById('promo-orden').value = 0;
                cargarPromosAdmin();
            }
        });

        // Cargar datos al iniciar
        cargarReservas();
        cargarGaleriaAdmin();
        cargarPromosAdmin();
    </script>
</body>
</html>
