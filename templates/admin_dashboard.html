<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="admin-page">
    <header>
        <div class="container">
            <h1>‚öôÔ∏è Panel Administrativo</h1>
            <a href="/admin/logout" class="btn btn-danger">Cerrar Sesi√≥n</a>
        </div>
    </header>

    <main class="container admin-container">
        <div class="sidebar">
            <nav>
                <button class="nav-btn active" data-tab="reservas">üìã Reservas</button>
                <button class="nav-btn" data-tab="canceladas">‚ùå Canceladas</button>
                <button class="nav-btn" data-tab="finalizadas">‚úÖ Finalizadas</button>
            </nav>
        </div>

        <div class="content">
            <div class="filters-bar">
                <div class="filter-group">
                    <label for="filtro-fecha-inicio">Desde</label>
                    <input type="date" id="filtro-fecha-inicio">
                </div>
                <div class="filter-group">
                    <label for="filtro-fecha-fin">Hasta</label>
                    <input type="date" id="filtro-fecha-fin">
                </div>
                <div class="filter-group filter-search">
                    <label for="filtro-busqueda">Buscar cliente</label>
                    <input type="text" id="filtro-busqueda" placeholder="Nombre, email o tel√©fono">
                </div>
                <button class="btn btn-secondary" id="filtro-limpiar">Limpiar</button>
            </div>

            <!-- TAB: RESERVAS -->
            <div id="tab-reservas" class="tab-content active">
                <h2>Reservas Activas</h2>
                <div id="reservasContainer" class="reservas-list">
                    <p>Cargando...</p>
                </div>
            </div>

            <!-- TAB: CANCELADAS -->
            <div id="tab-canceladas" class="tab-content">
                <h2>Reservas Canceladas</h2>
                <div id="canceladasContainer" class="reservas-list">
                    <p>Cargando...</p>
                </div>
            </div>

            <!-- TAB: FINALIZADAS -->
            <div id="tab-finalizadas" class="tab-content">
                <h2>Reservas Finalizadas</h2>
                <div id="finalizadasContainer" class="reservas-list">
                    <p>Cargando...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Cambiar tabs
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('tab-' + this.dataset.tab).classList.add('active');
            });
        });

        // ========== RESERVAS ==========
        let reservasCache = [];

        function normalizarTexto(valor) {
            return (valor || '').toString().toLowerCase().trim();
        }

        function filtrarReservas(lista) {
            const fechaInicioFiltro = document.getElementById('filtro-fecha-inicio').value;
            const fechaFinFiltro = document.getElementById('filtro-fecha-fin').value;
            const busqueda = normalizarTexto(document.getElementById('filtro-busqueda').value);

            const filtroInicio = fechaInicioFiltro ? new Date(fechaInicioFiltro) : null;
            const filtroFin = fechaFinFiltro ? new Date(fechaFinFiltro) : null;

            return lista.filter(r => {
                const inicio = new Date(r.fecha_inicio);
                const fin = new Date(r.fecha_fin);

                const coincideTexto = !busqueda || [
                    normalizarTexto(r.nombre_cliente),
                    normalizarTexto(r.email_cliente),
                    normalizarTexto(r.telefono_cliente),
                    normalizarTexto(r.domo_nombre)
                ].some(valor => valor.includes(busqueda));

                let coincideFecha = true;
                if (filtroInicio && filtroFin) {
                    coincideFecha = fin >= filtroInicio && inicio <= filtroFin;
                } else if (filtroInicio) {
                    coincideFecha = fin >= filtroInicio;
                } else if (filtroFin) {
                    coincideFecha = inicio <= filtroFin;
                }

                return coincideTexto && coincideFecha;
            });
        }

        function renderReservas() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            const activas = [];
            const canceladas = [];
            const finalizadas = [];

            filtrarReservas(reservasCache).forEach(r => {
                const fechaFin = new Date(r.fecha_fin);
                if (r.estado === 'cancelada') {
                    canceladas.push(r);
                } else if (fechaFin < hoy) {
                    finalizadas.push(r);
                } else {
                    activas.push(r);
                }
            });

            const activasHtml = activas.map(r => buildReservaCard(r, { canCancel: true })).join('');
            const canceladasHtml = canceladas.map(r => buildReservaCard(r, { canDelete: true })).join('');
            const finalizadasHtml = finalizadas.map(r => buildReservaCard(r, { canDelete: true })).join('');

            document.getElementById('reservasContainer').innerHTML = activasHtml || '<p>Sin reservas activas</p>';
            document.getElementById('canceladasContainer').innerHTML = canceladasHtml || '<p>Sin reservas canceladas</p>';
            document.getElementById('finalizadasContainer').innerHTML = finalizadasHtml || '<p>Sin reservas finalizadas</p>';
        }

        function buildReservaCard(r, options = {}) {
            const actions = [];
            if (options.canCancel && r.estado === 'confirmada') {
                actions.push(`<button class="btn btn-danger" onclick="cancelarReserva(${r.id})">Cancelar</button>`);
            }
            if (options.canDelete) {
                actions.push(`<button class="btn btn-secondary" onclick="eliminarReserva(${r.id})">Eliminar</button>`);
            }

            return `
                <div class="reserva-card">
                    <div class="reserva-header">
                        <h3>${r.domo_nombre}</h3>
                        <span class="status ${r.estado}">${r.estado}</span>
                    </div>
                    <div class="reserva-body">
                        <p><strong>Cliente:</strong> ${r.nombre_cliente}</p>
                        <p><strong>Email:</strong> ${r.email_cliente || 'N/A'}</p>
                        <p><strong>Tel√©fono:</strong> ${r.telefono_cliente || 'N/A'}</p>
                        <p><strong>Fechas:</strong> ${r.fecha_inicio} a ${r.fecha_fin}</p>
                    </div>
                    ${actions.length ? `<div class="reserva-actions">${actions.join('')}</div>` : ''}
                </div>
            `;
        }

        async function cargarReservas() {
            try {
                const res = await fetch('/api/admin/reservas');
                reservasCache = await res.json();
                renderReservas();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cancelarReserva(reservaId) {
            if (!confirm('¬øCancelar esta reserva?')) return;
            try {
                const res = await fetch(`/api/admin/reserva/${reservaId}`, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok) {
                    cargarReservas();
                    alert('Reserva cancelada');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function eliminarReserva(reservaId) {
            if (!confirm('¬øEliminar definitivamente esta reserva?')) return;
            try {
                const res = await fetch(`/api/admin/reserva/${reservaId}/eliminar`, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok) {
                    cargarReservas();
                    alert('Reserva eliminada');
                } else {
                    alert(data.error || 'No se pudo eliminar');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('filtro-fecha-inicio').addEventListener('change', renderReservas);
        document.getElementById('filtro-fecha-fin').addEventListener('change', renderReservas);
        document.getElementById('filtro-busqueda').addEventListener('input', renderReservas);
        document.getElementById('filtro-limpiar').addEventListener('click', () => {
            document.getElementById('filtro-fecha-inicio').value = '';
            document.getElementById('filtro-fecha-fin').value = '';
            document.getElementById('filtro-busqueda').value = '';
            renderReservas();
        });

        // Cargar datos al iniciar
        cargarReservas();
        cargarReservas();
    </script>
</body>
</html>
